name: Benchmarks

on:
  workflow_dispatch:
    inputs:
      run_performance:
        description: "Run Criterion performance benchmarks"
        type: boolean
        default: false
      run_quality:
        description: "Run quality benchmarks (tests on real repos)"
        type: boolean
        default: true
  schedule:
    # Weekly on Sunday at 03:00 UTC
    - cron: "0 3 * * 0"

concurrency:
  group: benchmarks-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  quality:
    name: Quality Benchmarks
    if: >-
      github.event_name == 'schedule' ||
      github.event.inputs.run_quality == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: bench-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: bench-cargo-

      - name: Cache test repositories
        id: cache-repos
        uses: actions/cache@v4
        with:
          path: benches/repos
          key: bench-repos-v1

      - name: Download test repositories
        if: steps.cache-repos.outputs.cache-hit != 'true'
        run: bash benches/download_repos.sh

      - name: Compile quality benchmarks
        run: cargo test --test quality_benchmarks --no-run

      - name: Run quality benchmarks
        run: |
          cargo test --test quality_benchmarks -- --ignored --nocapture 2>&1 | tee quality-results.txt
          echo ""
          echo "=== Summary ==="
          echo "Total tests: $(grep -c '#\[test\]' tests/quality_benchmarks.rs)"
          PASSED=$(grep -c "^test .* ok$" quality-results.txt || true)
          FAILED=$(grep -c "^test .* FAILED$" quality-results.txt || true)
          echo "Passed: $PASSED"
          echo "Failed: $FAILED"

      - name: Generate results summary
        if: always()
        run: |
          {
            echo "## Quality Benchmarks Results"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            TOTAL=$(grep -c '^test ' quality-results.txt || true)
            PASSED=$(grep -c '^test .* ok$' quality-results.txt || true)
            FAILED=$(grep -c '^test .* FAILED$' quality-results.txt || true)
            IGNORED=$(grep -c '^test .* ignored$' quality-results.txt || true)
            echo "| Total | $TOTAL |"
            echo "| Passed | $PASSED |"
            echo "| Failed | $FAILED |"
            echo "| Ignored | $IGNORED |"
            echo ""

            if [ "$FAILED" -gt 0 ]; then
              echo "### Failed tests"
              echo '```'
              grep '^test .* FAILED$' quality-results.txt || true
              echo '```'
            fi

            echo ""
            echo "### Comparison highlights"
            echo '```'
            grep -A1 "^===" quality-results.txt | head -80 || true
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload quality results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-results
          path: quality-results.txt
          retention-days: 30

  performance:
    name: Performance Benchmarks (Criterion)
    if: >-
      github.event_name == 'schedule' ||
      github.event.inputs.run_performance == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: bench-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: bench-cargo-

      - name: Cache test repositories
        id: cache-repos
        uses: actions/cache@v4
        with:
          path: benches/repos
          key: bench-repos-v1

      - name: Download test repositories
        if: steps.cache-repos.outputs.cache-hit != 'true'
        run: bash benches/download_repos.sh

      - name: Restore baseline
        id: baseline
        uses: actions/cache/restore@v4
        with:
          path: target/criterion
          key: criterion-baseline-${{ github.ref_name }}
          restore-keys: criterion-baseline-

      - name: Run indexing benchmarks
        run: cargo bench --bench indexing 2>&1 | tee bench-indexing.txt

      - name: Run search benchmarks
        run: cargo bench --bench search 2>&1 | tee bench-search.txt

      - name: Save baseline
        if: github.ref == 'refs/heads/master'
        uses: actions/cache/save@v4
        with:
          path: target/criterion
          key: criterion-baseline-${{ github.ref_name }}-${{ github.run_id }}

      - name: Generate performance summary
        if: always()
        run: |
          {
            echo "## Performance Benchmarks (Criterion)"
            echo ""
            echo "### Indexing"
            echo '```'
            grep -E "(time:|thrpt:)" bench-indexing.txt | head -30 || true
            echo '```'
            echo ""
            echo "### Search"
            echo '```'
            grep -E "(time:|thrpt:)" bench-search.txt | head -30 || true
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Criterion reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: criterion-reports
          path: |
            target/criterion/**/report/
            bench-indexing.txt
            bench-search.txt
          retention-days: 30
